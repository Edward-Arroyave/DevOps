name: Flyway Issue Creation

on:
  workflow_run:
    workflows: ["Flyway Azure SQL Migrations"]
    types:
      - completed

permissions:
  issues: write
  contents: read

jobs:
  create-issue:
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configurar variables para creaci√≥n de Issue
        run: |
          # Se obtiene el branch del workflow que fall√≥
          echo "BRANCH=${{ github.event.workflow_run.head_branch }}" >> $GITHUB_ENV
          # Se selecciona la URL seg√∫n el branch; en este ejemplo, si no es main se asume entorno DEV
          if [ "${{ github.event.workflow_run.head_branch }}" == "main" ]; then
            echo "FLYWAY_URL=${{ secrets.FLYWAY_URL_PROD }}" >> $GITHUB_ENV
          else
            echo "FLYWAY_URL=${{ secrets.FLYWAY_URL_DEV }}" >> $GITHUB_ENV
          fi

      - name: Crear Issue con GitHub CLI
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Extraer informaci√≥n del servidor y la base de datos desde FLYWAY_URL
          SERVER=$(echo "$FLYWAY_URL" | awk -F'//' '{split($2,a,";"); print a[1]}' | cut -d'.' -f1)
          DATABASE=$(echo "$FLYWAY_URL" | awk -F'databaseName=' '{print $2}' | cut -d';' -f1)
          FAILED_SCRIPT="Migraci√≥n fallida"
          ERROR_TYPE="üö® Error de Migraci√≥n"
          BODY="## ${ERROR_TYPE} en ${DATABASE}

          **Detalles T√©cnicos:**
          ‚ñ∏ Entorno: \`${{ github.event.workflow_run.head_branch }}\`
          ‚ñ∏ Servidor SQL: \`${SERVER}.database.windows.net\`
          ‚ñ∏ Recurso Fallido: \`${FAILED_SCRIPT}\`
          ‚ñ∏ Workflow: [${{ github.event.workflow_run.name }}](${{ github.event.workflow_run.html_url }})
          ‚ñ∏ Commit: [\`${{ github.event.workflow_run.head_commit.id.substring(0,7) }}\`](${{ github.event.workflow_run.head_commit.url }})"
          
          gh issue create \
            --title "[${SERVER^^}] ${ERROR_TYPE} - ${FAILED_SCRIPT}" \
            --body "$BODY" \
            --assignee "${{ github.event.workflow_run.triggering_actor.login }}" \
            --label "flyway"
