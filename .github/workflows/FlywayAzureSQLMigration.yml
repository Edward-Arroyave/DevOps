name: Flyway Migration

on:
  push:
    branches:
      - main

jobs:
  flyway_migration:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Flyway
        run: |
          curl -L "https://repo1.maven.org/maven2/org/flywaydb/flyway-commandline/11.3.3/flyway-commandline-11.3.3-linux-x64.tar.gz" -o flyway.tar.gz
          tar -xzf flyway.tar.gz
          sudo mv flyway-11.3.3 /opt/flyway
          echo "/opt/flyway" >> $GITHUB_PATH

      - name: Run Flyway Migration
        id: flyway_migrate
        continue-on-error: true
        run: |
          /opt/flyway/flyway -url=$FLYWAY_URL -user=$FLYWAY_USER -password=$FLYWAY_PASSWORD migrate 2>&1 | tee flyway_error.log
          EXIT_CODE=${PIPESTATUS[0]}
          if [ $EXIT_CODE -ne 0 ]; then
            echo "FAILURE" > flyway_failed.log
            exit $EXIT_CODE
          fi

      - name: Handle Migration Error
        if: failure()
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          FAILED_SCRIPT=$(grep "Migrating" flyway_error.log | tail -n 1 | awk '{print $NF}')
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")

          BODY="## ðŸš¨ Flyway Migration Error Report  
          **Migration File:** $FAILED_SCRIPT  
          **Error Message:** $(tail -n 5 flyway_error.log)  
          **Event Trigger:** flyway migrate  
          **Commit Hash:** ${{ github.sha }}  
          **Date & Time:** $TIMESTAMP  
          **Git Actor:** ${{ github.actor }}  
          **Logs:** See attached log file."

          gh issue create \
            --title "[${{ github.repository }}] ðŸš¨ Error en migraciÃ³n - ${FAILED_SCRIPT##*/}" \
            --body "$BODY" \
            --assignee "Edward-Arroyave" \
            --label "flyway,bug,migration-error"

    env:
      FLYWAY_URL: ${{ secrets.FLYWAY_URL }}
      FLYWAY_USER: ${{ secrets.FLYWAY_USER }}
      FLYWAY_PASSWORD: ${{ secrets.FLYWAY_PASSWORD }}
