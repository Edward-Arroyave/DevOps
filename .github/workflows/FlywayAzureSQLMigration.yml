name: Flyway Migration

on:
  push:
    branches:
      - main

jobs:
  flyway_migration:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate environment variables
        run: |
          if [[ -z "$FLYWAY_URL" || -z "$FLYWAY_USER" || -z "$FLYWAY_PASSWORD" ]]; then
            echo "âŒ ERROR: Missing Flyway credentials. Please check your secrets."
            exit 1
          fi

      - name: Set up Flyway
        run: |
          curl -L "https://repo1.maven.org/maven2/org/flywaydb/flyway-commandline/11.3.3/flyway-commandline-11.3.3-linux-x64.tar.gz" -o flyway.tar.gz
          tar -xzf flyway.tar.gz
          sudo mv flyway-11.3.3 /opt/flyway
          echo "/opt/flyway" >> $GITHUB_PATH

      - name: Run Flyway Migration
        id: flyway_migrate
        continue-on-error: true
        run: |
          /opt/flyway/flyway -url=$FLYWAY_URL -user=$FLYWAY_USER -password=$FLYWAY_PASSWORD migrate 2>&1 | tee flyway_error.log
          EXIT_CODE=${PIPESTATUS[0]}
          if [ $EXIT_CODE -ne 0 ]; then
            echo "Flyway failed. Capturing logs..." 
            echo "FAILURE" > flyway_failed.log
            exit $EXIT_CODE
          fi

      - name: Handle Migration Error
        if: failure()
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          if [ ! -f flyway_error.log ]; then
            echo "âš ï¸ No error log found, skipping issue creation."
            exit 1
          fi

          FAILED_SCRIPT=$(grep "Migrating" flyway_error.log | tail -n 1 | awk '{print $NF}')
          if [ -z "$FAILED_SCRIPT" ]; then
            FAILED_SCRIPT="N/A (Connection Error or Configuration Issue)"
          fi

          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")

          BODY="## ðŸš¨ Flyway Migration Error Report  
          **Migration File:** $FAILED_SCRIPT  
          **Error Message:** $(tail -n 5 flyway_error.log)  
          **Event Trigger:** flyway migrate  
          **Commit Hash:** ${{ github.sha }}  
          **Date & Time:** $TIMESTAMP  
          **Git Actor:** ${{ github.actor }}  
          **Logs:** See attached log file."

          echo "$BODY" > issue_body.md

          gh issue create \
            --title "[${{ github.repository }}] ðŸš¨ Error en migraciÃ³n - ${FAILED_SCRIPT##*/}" \
            --body-file issue_body.md \
            --assignee "Edward-Arroyave" \
            --label "flyway,bug,migration-error"
